@inherits LayoutComponentBase
@implements IAsyncDisposable
@inject IJSRuntime JS

<div class="app-shell">
    <header class="glass-panel app-header">
        <h1>SonicMemo</h1>
        <OfflineStatusIndicator Status="@_offlineStatus" />
    </header>
    <main>
        @Body
    </main>
</div>

<OfflineToast IsVisible="@_showOfflineToast"
              Message="App is ready for offline use."
              OnDismiss="@HideOfflineToast" />

@code {
    private string _offlineStatus = "downloading";
    private bool _showOfflineToast;
    private DotNetObjectReference<MainLayout>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("offlineBridge.init", _dotNetRef);
    }

    [JSInvokable]
    public Task SetOfflineStatus(string status)
    {
        _offlineStatus = status;
        return InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public Task ShowOfflineReadyToast()
    {
        _showOfflineToast = true;
        return InvokeAsync(StateHasChanged);
    }

    private Task HideOfflineToast()
    {
        _showOfflineToast = false;
        return InvokeAsync(StateHasChanged);
    }

    public ValueTask DisposeAsync()
    {
        _dotNetRef?.Dispose();
        return ValueTask.CompletedTask;
    }
}
